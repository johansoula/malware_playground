#!/usr/bin/env python

import re
import subprocess
import shutil
import sys

def get_scanner_results(repo, vir):
    scanner_output = scan_dir(repo)
    results = parse_output(scanner_output, repo, True)
    return results

def scan_dir(directory):
    scanner = subprocess.Popen(['/opt/COMODO/cmdscan', '-v', '-s', directory], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
    try:
       output = scanner.communicate()[0].splitlines()
       return output
    except:
       return None

def parse_output(output, directory, action):
    log = open("detected_virus.log", "a")

    for line in output:
#/opt/cascade_export/virus/140238.XLS.bitdefender ---> Found Virus, Malware Name
        pest_name = re.search("%s/*(.+)(.clamav)* ---> Found Virus, Malware Name is (.+)" % directory, line)
        if pest_name:
            virus= pest_name.group(3).decode(encoding='utf-8')
            filename= pest_name.group(1).decode(encoding='utf-8')
            scan = "file=\"%s\" engine=comodo sig=\"%s\"\r\n" % (filename, virus)
            log.write(scan)
            if action:
                shutil.copy("%s/%s" % (repo, filename), "%s/%s" % (vir, filename))
    log.close

if len(sys.argv) > 1:
    repo = sys.argv[1]
else:
    repo = "working_dir"

if len(sys.argv) > 2:
    vir = sys.argv[2]
else:
    vir = "virus"


scan = get_scanner_results(repo, vir)
    
exit(0)


